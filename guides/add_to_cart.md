# add_to_cart 이벤트 가이드

## 이벤트 정의
**상품을 장바구니에 추가했을 때** 발생하는 이벤트입니다.
구매 의사가 있는 제품을 장바구니에 추가하는 행동을 추적합니다.
**버튼 클릭 시점이 아닌, 유효성 검사 통과 후 실제 추가 완료 시** 발생합니다.

---

## 1. 시각적 판단 기준 (Primary - 화면에서 찾기)

### 장바구니 담기 버튼의 시각적 특징

#### 1) 메인 장바구니 버튼
- **위치**: 상품 상세 페이지의 구매 옵션 영역
- **형태**: 대형 CTA 버튼
- **시각 요소**:
  - 쇼핑카트/바구니 아이콘
  - "장바구니", "담기", "Add to Cart" 텍스트
  - 강조색 배경 (브랜드 컬러)
  - 가격 정보 근처 위치

#### 2) 퀵 카트 아이콘
- **위치**: 상품 카드 위 (호버 시 나타남)
- **형태**: 아이콘 버튼
- **시각 요소**:
  - 장바구니/쇼핑백 아이콘
  - 호버 시 표시되는 오버레이
  - 상품 이미지 모서리에 위치

#### 3) 수량 선택 + 담기 조합
- **구성**: 수량 선택 UI + 장바구니 버튼
- **특징**:
  - +/- 버튼 또는 수량 입력 필드
  - 옵션 선택 드롭다운과 함께 위치

### 장바구니 버튼이 아닌 영역 (시각적 구분)

| 영역 | 특징 | 해당 이벤트 |
|-----|------|--------------|
| 상품 카드/이미지 | 상세 페이지로 이동 | `select_item` |
| "바로 구매" 버튼 | 결제 페이지로 이동 | `begin_checkout` |
| 찜하기/하트 아이콘 | 위시리스트 추가 | `add_to_wishlist` |
| 헤더 장바구니 아이콘 | 장바구니 페이지 이동 | 없음 |

---

## 2. GTM 트리거 조건 (검증용)

### 현재 구현된 조건
```
트리거 타입: CUSTOM_EVENT (dataLayer push)
Custom Event: [사이트별 상이 - site-config.json 참조]
발생 조건: 유효성 검사 통과 + 서버 응답 성공
```

### 사이트별 dataLayer event명 예시
| 사이트 | dataLayer event | GA4 이벤트 | 설정 파일 |
|-------|-----------------|-----------|----------|
| Amoremall | `addcart` | `add_to_cart` | `sites/amoremall-kr/site-config.json` |
| Innisfree Shopify | `cart` | `add_to_cart` | `sites/innisfree-shopify/site-config.json` |

### 유효성 검사 조건
이벤트는 다음 검사가 통과된 후에만 발생해야 합니다:
- 필수 옵션 선택 완료 (사이즈, 색상 등)
- 재고 확인 완료
- 수량 유효성 확인
- 서버 응답 성공

### dataLayer 구조

**참고**: 실제 `event` 값은 사이트마다 다릅니다. `sites/{site}/site-config.json`의 `eventMapping.add_to_cart` 값을 확인하세요.

```javascript
// GA4 이벤트: add_to_cart
// dataLayer event명은 사이트별 설정 참조
dataLayer.push({
  event: "[eventMapping.add_to_cart]",  // 예: "addcart", "cart" 등
  ecommerce: {
    currency: "KRW",
    value: 50000,
    items: [{
      item_id: "SKU_12345",
      item_name: "수분 크림",
      price: 25000,
      quantity: 2
    }]
  }
});
```

---

## 3. 분석 판단 프로세스

### Step 1: 시각적으로 장바구니 버튼 식별
화면에서 다음 특징을 가진 요소를 찾습니다:
- 쇼핑카트/바구니 아이콘
- "담기", "장바구니", "Cart" 텍스트
- CTA 스타일 버튼 (강조색)

### Step 2: 다른 버튼과 구분
다음 기준으로 구분합니다:
- **장바구니 담기**: 장바구니에 추가, 페이지 유지
- **바로 구매**: 결제 페이지로 이동
- **찜하기**: 하트 아이콘, 위시리스트 추가

### Step 3: 트래킹 확인
- 버튼 클릭 시 dataLayer에 `addcart` 이벤트 push 여부
- 유효성 검사 후 발생하는지 확인

### Step 4: 결과 분류

#### Case A: 장바구니 버튼 + 트래킹 있음
→ **Should Fire**: 성공적인 추가 완료 시 이벤트 발생

#### Case B: 장바구니 버튼 + 트래킹 없음
→ **구현 누락**: 이벤트 추적 코드 추가 필요

#### Case C: 바로 구매/찜하기 버튼
→ **Should NOT Fire**: 다른 이벤트 대상

---

## 4. 구현 검증 포인트

### 필수 확인 사항
1. **모든 장바구니 버튼에서 트래킹**
   - 상품 상세 페이지 메인 버튼
   - 상품 카드 퀵 카트 아이콘
   - 옵션 선택 후 담기 버튼

2. **발생 시점**
   - 버튼 클릭 시점이 아닌 성공 응답 후
   - 유효성 검사 실패 시 미발생

3. **수량 정확성**
   - 실제 추가된 수량이 quantity에 반영

### 흔한 구현 오류
| 문제 | 증상 | 해결 방법 |
|-----|------|----------|
| 클릭 시 발생 | 실패해도 이벤트 발생 | 성공 콜백에서 push |
| 퀵 카트 누락 | 상품 카드에서 트래킹 없음 | 모든 담기 버튼에 적용 |
| 수량 오류 | quantity가 항상 1 | 실제 수량 전달 |
| **dataLayer 중복 push** | 동일 상품 add_to_cart 2회 발생 | dataLayer push 호출 지점 확인 |

---

## 5. 수집 파라미터

> **중요**: 아래 파라미터는 **대표 예시**입니다.
> 실제 구현은 사이트별 GTM 설정에 따라 다르므로, **시나리오 설계 시 반드시 GTM 파싱을 통해 실제 파라미터를 확인**해야 합니다.
>
> ⚠️ **필수 확인 사항**: 없는 파라미터나 추가해야 하는 파라미터는 항상 **GTM parser를 통해 확인**이 필요합니다.
> GTM 파싱 방법: [docs/gtm-parsing-guide.md](../docs/gtm-parsing-guide.md) 참조

### GTM Variable 참조 (Amoremall 기준)

| 파라미터 | GTM Variable | 설명 |
|---------|--------------|------|
| event_category | (하드코딩) | "ecommerce" |
| event_action | (하드코딩) | "add to cart" |
| items | `{{JS - Add to Cart DataLayer}}` | 상품 배열 (**dataLayer variable에서 확인**) |
| currency | `{{JS - Currency}}` | 통화 코드 |

> 💡 **items 확인 방법**: GTM 변수 `{{JS - Add to Cart DataLayer}}`의 정의를 확인하면 items 배열의 구조를 파악할 수 있습니다.
> dataLayer에서 직접 확인: `dataLayer.filter(e => e.ecommerce?.items)`

### 이벤트 레벨 파라미터

| 파라미터 | 설명 | 예시 |
|---------|------|------|
| event_category | 이벤트 카테고리 | "ecommerce" |
| event_action | 이벤트 액션 | "add to cart" |
| currency | 통화 | "KRW" |
| items | 상품 배열 | [{...}] |

### items 배열 파라미터

| 파라미터 | 설명 | 예시 | 필수 |
|---------|------|------|-----|
| item_id | 상품 고유 ID | "SKU_12345" | O |
| item_name | 상품명 | "수분 크림" | O |
| item_brand | 브랜드명 | "설화수" | O |
| item_category | 대분류 | "스킨케어" | O |
| item_category2 | 중분류 | "크림" | △ |
| item_category3 | 소분류 | "수분크림" | △ |
| item_category4 | 세분류 4 | - | △ |
| item_category5 | 세분류 5 | - | △ |
| item_variant | 옵션/용량 | "50ml" | △ |
| price | 판매 단가 | 25000 | O |
| quantity | 수량 | 2 | O |
| discount | 할인금액 | 5000 | △ |
| original_price | 정가 | 30000 | △ |

### 사이트별 추가 파라미터 (Amoremall 예시)

| 파라미터 | 설명 | GTM 변수 |
|---------|------|----------|
| apg_brand_code | APG 브랜드 코드 | item.apg_brand_code |
| internal_brand_code | 내부 브랜드 코드 | item.internal_brand_code |

---

## 6. 관련 이벤트

| 이벤트 | 발생 시점 | 구분 |
|-------|----------|------|
| `select_item` | 상품 클릭 | 상세 페이지 이동 |
| `view_item` | 상품 상세 로드 | 페이지 로드 |
| `add_to_cart` | 장바구니 담기 성공 | 클릭 이벤트 (성공 콜백) |
| `remove_from_cart` | 장바구니에서 제거 | 클릭 이벤트 |
| `begin_checkout` | 결제 시작 | 바로 구매 시 |

---

## 7. 시나리오 예시

### Should Fire (성공 시)
```
- 상품 상세에서 옵션 선택 후 "장바구니 담기" 클릭 (성공 응답 후)
- 상품 카드의 퀵 카트 아이콘 클릭 (성공 응답 후)
- 수량 2개 선택 후 "카트에 담기" 클릭 (성공 응답 후)
- 장바구니 추가 완료 토스트/팝업 표시 시
```

### Should NOT Fire
```
- 상품 이미지 클릭 → select_item
- "바로 구매" 버튼 클릭 → begin_checkout
- 헤더의 장바구니 아이콘 클릭 (페이지 이동)
- "찜하기" 하트 아이콘 클릭 → add_to_wishlist
- 필수 옵션 미선택으로 "옵션을 선택해주세요" 알림 표시
- 재고 부족으로 추가 실패
```

### 구현 필요 (Gap)
```
- 장바구니 버튼처럼 보이지만 클릭 트래킹 없음
- 퀵 카트 아이콘에 이벤트 미적용
- 클릭 시점에 발생하고 실패해도 발생함
- 옵션 선택 팝업 내 담기 버튼 트래킹 누락
```

### 상세 시나리오 매트릭스

| 시나리오 | 진행방법 | 발생해야 하는 상황 | 발생하면 안 되는 상황 | 주요 검수 포인트 |
|---------|---------|------------------|---------------------|----------------|
| **상품 추가 확인** | 상품 리스트영역, 상품 상세페이지 영역, 장바구니 버튼 추가 | 사용자가 유효성 검사를 통과한 후 상품을 장바구니에 성공적으로 추가했을 때 | 상품 추가 시도가 실패했거나 (옵션 미선택, 재고 부족 등), 장바구니 페이지 로드 시 | 이벤트가 정확한 시점에만 발생하는지 확인, 실패 시 이벤트 미발생 검증 |
| **옵션 선택 미완료** | 필수 옵션에서 장바구니 추가 버튼 | - | 옵션 선택 없이 add_to_cart 이벤트가 발생했을 경우 | 모든 필수 옵션이 선택되었는지 확인, 누락된 선택 시 이벤트 차단 |
| **중복 이벤트 방지** | 상품 리스트영역, 상품 상세페이지 영역, 장바구니 버튼 추가 | 한 번의 상품 추가 작업에 대해 하나의 이벤트만 발생해야 함 | 사용자의 단일 클릭에 여러 번의 이벤트가 기록되는 경우 | 이벤트 중복 발생 검사, 클라이언트와 서버측 로그 확인 |
| **비동기 처리** | 미적용 | 비동기적으로 상품 정보나 재고를 업데이트 한 후 장바구니에 추가 시 | 비동기 업데이트 도중 장바구니 추가 버튼이 활성화되어 이벤트가 발생했을 경우 | 비동기 상태에서의 이벤트 처리 방식 검증, 콜백과 프로미스 처리 확인 |
| **크로스 플랫폼 일관성** | 미적용 | 모바일과 데스크톱에서 동일한 방식으로 이벤트가 처리되어야 함 | 플랫폼에 따라 이벤트 발생에 차이가 나는 경우 | 플랫폼별 이벤트 발생 일관성 검사, 반응형 디자인과 기능적 일관성 확인 |

### 시나리오별 상세 검증 항목

#### 1) 상품 추가 확인
```
진행 방법:
1. 상품 리스트 영역, 상품 상세페이지 영역에서 장바구니 버튼 클릭
2. 옵션 선택이 필요한 경우 옵션 선택 후 담기
3. 장바구니 추가 성공 확인

검증 항목:
□ 유효성 검사를 통과한 후 상품을 장바구니에 성공적으로 추가했을 때 add_to_cart 발생
□ 상품 추가 시도가 실패했을 때 (옵션 미선택, 재고 부족 등) 미발생
□ 장바구니 페이지 로드 시 미발생
□ 이벤트가 정확한 시점에만 발생하는지 확인
□ 실패 시 이벤트 미발생 검증
□ item_id, item_name, quantity, price 등 데이터 정확성 확인
```

#### 2) 옵션 선택 미완료
```
진행 방법:
1. 필수 옵션이 있는 상품 상세 페이지 접근
2. 필수 옵션 선택하지 않은 상태에서 장바구니 추가 버튼 클릭
3. 옵션 선택 요청 메시지 확인

검증 항목:
□ 옵션 선택 없이 add_to_cart 이벤트 미발생
□ 모든 필수 옵션이 선택되었는지 확인
□ 누락된 선택 시 이벤트 차단
□ 옵션 선택 후 담기 성공 시에만 이벤트 발생
□ 유효성 검사 실패 메시지 표시 시 이벤트 미발생
```

#### 3) 중복 이벤트 방지
```
진행 방법:
1. 상품 리스트 영역 또는 상품 상세페이지에서 장바구니 버튼 클릭
2. 빠른 연속 클릭 시도
3. dataLayer에서 이벤트 발생 횟수 확인

검증 항목:
□ 한 번의 상품 추가 작업에 대해 하나의 이벤트만 발생
□ 사용자의 단일 클릭에 여러 번의 이벤트가 기록되지 않음
□ 이벤트 중복 발생 검사
□ 클라이언트와 서버측 로그에서 중복 확인
□ 버튼 더블클릭 방지 로직 작동 확인
```

#### 4) 비동기 처리
```
진행 방법:
1. 비동기적으로 상품 정보나 재고를 업데이트하는 상황 시뮬레이션
2. 업데이트 완료 후 장바구니 추가 시도
3. 업데이트 중 장바구니 추가 시도 (가능한 경우)

검증 항목:
□ 비동기적으로 상품 정보/재고 업데이트 후 장바구니 추가 시 정상 발생
□ 비동기 업데이트 도중 버튼 활성화되어 이벤트 발생 방지
□ 비동기 상태에서의 이벤트 처리 방식 검증
□ 콜백과 프로미스 처리 확인
□ 로딩 상태에서 버튼 비활성화 여부 확인
```

#### 5) 크로스 플랫폼 일관성
```
진행 방법:
1. PC 환경에서 장바구니 추가 테스트
2. Mobile 환경에서 동일 테스트 수행
3. 양쪽 환경의 이벤트 데이터 비교

검증 항목:
□ 모바일과 데스크톱에서 동일한 방식으로 이벤트 처리
□ 플랫폼에 따라 이벤트 발생에 차이가 없는지 확인
□ 플랫폼별 이벤트 발생 일관성 검사
□ 반응형 디자인과 기능적 일관성 확인
□ 동일한 데이터 구조로 이벤트가 발생하는지 확인
```

#### 6) dataLayer 중복 push로 인한 중복 발생 (주의 케이스)
```
발생 상황:
- 장바구니 추가 시 add_to_cart(addcart) 이벤트가 2회 이상 발생
- 동일한 상품인데 이벤트가 중복으로 수집됨

원인 분석 방법:
1. 개발자 도구 Console에서 dataLayer 확인
2. dataLayer.filter(e => e.event === 'addcart') 실행 (사이트별 event명 확인)
3. addcart 이벤트가 몇 번 push되었는지 확인

일반적인 중복 push 원인:
□ 프론트엔드 코드에서 dataLayer.push가 2회 호출됨
□ API 성공 콜백이 중복 실행됨
□ 컴포넌트 렌더링 시 중복 실행 (React 등 SPA에서 발생 가능)
□ GTM 태그 설정에서 중복 트리거 적용
□ 장바구니 추가 모달과 페이지 갱신 시 각각 push

검증 항목:
□ dataLayer에서 addcart 이벤트 push 횟수 확인 (1회만 되어야 함)
□ 중복 발생 시 두 이벤트의 데이터가 동일한지 비교
□ 발생 시점(timestamp) 확인하여 어느 지점에서 중복되는지 분석
□ 개발팀에 중복 push 지점 수정 요청

디버깅 코드 (Console에서 실행):
dataLayer.filter(e => e.event === 'addcart').forEach((e, i) => {
  console.log('addcart push #' + (i+1), e);
});
```

---

## 8. 시나리오 작성 지침

### 트리거 타입: CUSTOM_EVENT (dataLayer.push)

이 이벤트는 **dataLayer.push로 발생**합니다.
프론트엔드에서 장바구니 추가 API 성공 후 dataLayer.push를 호출하여 이벤트를 발생시킵니다.

### 시나리오에 포함할 내용
```
O 포함해야 함:
- 예상 dataLayer 구조 (dataLayer.push 코드)
- event 이름 (addcart → GA4에서 add_to_cart로 매핑)
- ecommerce 객체 구조
- items 배열 내 파라미터

X 포함하지 않음:
- GTM LINK_CLICK 트리거 관련 내용
- DOM 속성에서 데이터 추출하는 방식
```

### 예상 dataLayer 구조 (시나리오에 포함)

**사이트별 event명 확인 필수**: `sites/{site}/site-config.json` → `eventMapping.add_to_cart`

```javascript
// 예시: Amoremall (event: "addcart")
dataLayer.push({
  event: "addcart",  // site-config.json에서 확인
  ecommerce: {
    currency: "KRW",
    value: 50000,
    items: [{
      item_id: "SKU_12345",
      item_name: "수분 크림",
      item_brand: "설화수",
      price: 25000,
      quantity: 2
    }]
  }
});
```

### 검증 포인트
```
1. dataLayer 확인:
   - 개발자도구 Console에서 dataLayer 배열 확인
   - addcart 이벤트 객체가 push되는지 확인

2. 발생 시점 확인:
   - 버튼 클릭 즉시가 아닌 API 성공 후 발생
   - 실패 시 이벤트 미발생
```

---

## 9. 퍼널 데이터 일관성 검증

### 이 이벤트의 퍼널 위치
```
select_item → view_item → add_to_cart → view_cart → begin_checkout → purchase
                              ↑
                          현재 위치
```

### 일관성 검증 항목

동일 상품에 대해 **이전/이후 이벤트와 다음 파라미터가 일치해야 합니다**:

| 파라미터 | 일치 대상 이벤트 | 검증 기준 |
|---------|----------------|----------|
| `item_id` | select_item, view_item, view_cart, begin_checkout, purchase | 동일 상품은 항상 동일 ID |
| `item_name` | 모든 퍼널 이벤트 | 정확히 일치 |
| `item_brand` | 모든 퍼널 이벤트 | 정확히 일치 |
| `item_category` | 모든 퍼널 이벤트 | 정확히 일치 |
| `price` | view_item, view_cart, begin_checkout, purchase | 할인/쿠폰 적용 전 단가 |

### 불일치 위험 케이스

| 상황 | 위험 | 검증 방법 |
|-----|------|----------|
| 옵션 선택으로 가격 변경 | price 불일치 | 옵션 선택 전후 price 비교 |
| 세트 상품 분리 수집 | item_id 불일치 | 세트 상품 item_id 확인 |
| 프로모션 적용 | price에 할인 반영 여부 | 정가 vs 판매가 확인 |
| 국제화 상품명 | item_name 불일치 | 언어별 상품명 확인 |

### 검증 체크리스트
```
□ view_item의 item_id와 add_to_cart의 item_id 일치
□ view_item의 item_name과 add_to_cart의 item_name 일치
□ view_item의 price와 add_to_cart의 price 일치 (옵션 변경 제외)
□ add_to_cart의 item_id가 이후 view_cart, purchase에서도 동일
```

---

## 10. 발생 페이지별 검증

### add_to_cart 발생 가능 페이지

이 이벤트는 **여러 페이지에서 발생**할 수 있으며, 동일 상품은 어느 페이지에서 담아도 **동일한 데이터**를 수집해야 합니다.

| 페이지 | 트리거 UI | 특징 |
|-------|----------|------|
| 메인 페이지 | "바로 담기" 버튼 | 추천 상품 퀵 담기 |
| 카테고리 페이지 | "담기" 아이콘 | 상품 카드 호버 시 노출 |
| 상품 상세 페이지 | "장바구니 담기" 버튼 | 옵션 선택 후 담기 (메인) |
| 장바구니 페이지 | "추천 상품 담기" | 추가 상품 담기 |
| 검색 결과 페이지 | "담기" 아이콘 | 상품 카드 호버 시 노출 |
| 위시리스트 | "장바구니로 이동" | 찜한 상품 담기 |

### 페이지별 일관성 검증

**동일 상품(SKU_12345)을 각 페이지에서 담았을 때**:

```javascript
// 모든 페이지에서 동일한 데이터가 수집되어야 함
{
  item_id: "SKU_12345",      // 모든 페이지에서 동일
  item_name: "수분 크림",    // 모든 페이지에서 동일
  item_brand: "설화수",      // 모든 페이지에서 동일
  item_category: "스킨케어", // 모든 페이지에서 동일
  price: 25000              // 모든 페이지에서 동일
}
```

### 페이지별 차이 위험 케이스

| 페이지 | 위험 요소 | 확인 사항 |
|-------|----------|----------|
| 메인 페이지 | 축약된 상품명 사용 | item_name 정확성 |
| 카테고리 페이지 | 브랜드명 미표시 | item_brand 수집 여부 |
| 퀵뷰 모달 | 불완전한 데이터 | 모든 파라미터 수집 |
| 위시리스트 | 과거 데이터 사용 | 현재 가격 반영 |

### 크로스페이지 검증 체크리스트
```
□ 메인 페이지에서 담기: 상품 데이터 완전성 확인
□ 카테고리 페이지에서 담기: 동일 상품 데이터 일치 확인
□ 상품 상세에서 담기: 기준 데이터로 활용
□ 위시리스트에서 담기: 최신 상품 정보 반영 확인
□ 모든 페이지의 item_id, item_name, price 일치 여부
```

---

## 11. 이벤트 버블링 위험

### 버블링 발생 시나리오

이 이벤트는 CUSTOM_EVENT(dataLayer.push) 방식이지만, **버튼 클릭을 감지하는 구현**에서 버블링 이슈가 발생할 수 있습니다.

```html
<!-- 중첩 구조 예시 -->
<div class="product-card">
  <button class="add-to-cart-btn">
    <span class="icon">🛒</span>
    <span class="text">담기</span>
  </button>
</div>
```

### 버블링 위험 케이스

| 상황 | 위험 | 검증 방법 |
|-----|------|----------|
| 아이콘 클릭 vs 버튼 클릭 | 이벤트 핸들러 중복 실행 | 각 영역 클릭 테스트 |
| 퀵 카트 아이콘 클릭 | 상품 카드 클릭과 충돌 | select_item 중복 발생 확인 |
| 수량 선택 버튼 클릭 | 담기 버튼과 혼동 | 수량만 변경되는지 확인 |

### 중복 발생 위험

| 상황 | 예상 결과 | 실제 위험 |
|-----|----------|----------|
| 퀵 카트 아이콘 클릭 | add_to_cart 1회 | select_item + add_to_cart 동시 발생 |
| "담기" 버튼 더블클릭 | add_to_cart 1회 | add_to_cart 2회 발생 |
| 옵션 선택 팝업에서 담기 | add_to_cart 1회 | 팝업 열림 + 담기에서 2회 발생 |

### 버블링 검증 체크리스트
```
□ 버튼 아이콘 영역 클릭 시 이벤트 1회만 발생
□ 버튼 텍스트 영역 클릭 시 이벤트 1회만 발생
□ 퀵 카트 클릭 시 select_item 미발생 (add_to_cart만)
□ 빠른 연속 클릭 시 중복 방지 확인
□ 옵션 선택 후 담기 시 1회만 발생
```

---

## 12. 환경별 검증

> **공통 가이드 참조**: [docs/environment-validation-guide.md](../docs/environment-validation-guide.md)
>
> PC/Mobile, 로그인/비로그인 환경별 검증은 공통 가이드를 참조하세요.

### add_to_cart 특화 환경 검증

| 환경 | 특이사항 |
|-----|---------|
| Mobile | 스와이프 담기 UI, 퀵카트 버튼 탭 영역 확인 |
| PC 호버 | 호버 시 나타나는 퀵카트 버튼 클릭 테스트 |
| 비로그인 | 비로그인 장바구니 지원 여부에 따라 동작 확인 |
