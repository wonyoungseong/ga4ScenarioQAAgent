# write_review 이벤트 가이드

## 이벤트 정의
**사용자가 상품 리뷰를 작성 완료했을 때** 발생하는 이벤트입니다.
리뷰 작성 버튼 클릭이 아닌, 리뷰가 성공적으로 제출된 시점에 발생합니다.
**리뷰 제출 성공 시** 발생합니다.

---

## 1. 시각적 판단 기준 (Primary - 화면에서 찾기)

### 리뷰 작성 영역의 시각적 특징

#### 1) 리뷰 작성 버튼/링크
- **위치**: 상품 상세 페이지 리뷰 탭, 마이페이지
- **텍스트**: "리뷰 작성", "후기 작성", "Write Review"
- **조건**: 구매 완료 후 활성화

#### 2) 리뷰 작성 폼
- **구성 요소**:
  - 별점 선택 (1~5점)
  - 리뷰 내용 입력 (텍스트 영역)
  - 이미지 첨부 옵션
  - 옵션 정보 표시 (구매한 옵션)
  - "등록" 또는 "작성 완료" 버튼

#### 3) 리뷰 작성 완료 화면
- **시각 요소**:
  - 완료 메시지 ("리뷰가 등록되었습니다")
  - 적립 포인트 안내
  - 작성한 리뷰 미리보기

### 리뷰 작성이 아닌 화면 (시각적 구분)

| 화면 | 특징 | 해당 이벤트 |
|-----|------|--------------|
| 리뷰 목록 보기 | 다른 사용자 리뷰 나열 | 없음 |
| 별점만 선택 | 간편 평가 (내용 없음) | 별도 이벤트 |
| Q&A 작성 | 질문/답변 형식 | 없음 |

---

## 2. GTM 트리거 조건 (검증용)

### 현재 구현된 조건
```
트리거 타입: CUSTOM_EVENT (dataLayer push)
Custom Event: [사이트별 상이 - site-config.json 참조]
발생 시점: 리뷰 제출 API 응답 성공 시
```

### 발생 조건
```
- 리뷰 작성 폼에서 내용 입력 후 제출 성공
- 별점 + 텍스트 리뷰 등록 완료
- 포토 리뷰 등록 완료
```

### dataLayer 구조

**참고**: 실제 `event` 값은 사이트마다 다릅니다. `sites/{site}/site-config.json`의 `eventMapping.write_review` 값을 확인하세요.

```javascript
// GA4 이벤트: write_review
// dataLayer event명은 사이트별 설정 참조
dataLayer.push({
  event: "[eventMapping.write_review]",  // 예: "review", "write_review" 등
  item_id: "SKU_12345",
  item_name: "수분 크림",
  rating: 5,
  review_type: "photo" // 또는 "text"
});
```

### 사이트별 dataLayer event명 예시
| 사이트 | dataLayer event | 설정 파일 |
|-------|-----------------|----------|
| Amoremall | `review` | `sites/amoremall-kr/site-config.json` |
| Innisfree Shopify | `review` | `sites/innisfree-shopify/site-config.json` |

---

## 3. 분석 판단 프로세스

### Step 1: 시각적으로 리뷰 작성 영역 식별
화면에서 다음 특징을 가진 요소를 찾습니다:
- 별점 선택 UI
- 리뷰 내용 입력 필드
- "리뷰 작성", "등록" 버튼

### Step 2: 리뷰 제출 상태 확인
다음 기준으로 확인합니다:
- **작성 전**: 빈 폼, 작성 버튼 활성화
- **작성 중**: 내용 입력 중
- **작성 완료**: 완료 메시지 표시, 리뷰 목록에 추가됨

### Step 3: 트래킹 확인
- 리뷰 제출 성공 시 dataLayer에 `write_review` push 여부
- 상품 정보, 별점 등 파라미터 포함 여부

### Step 4: 결과 분류

#### Case A: 리뷰 제출 완료 + 트래킹 있음
→ **Should Fire**: 제출 성공 후 이벤트 발생

#### Case B: 리뷰 제출 완료 + 트래킹 없음
→ **구현 누락**: 성공 콜백에 dataLayer push 추가 필요

#### Case C: 작성 버튼 클릭만 (제출 전)
→ **Should NOT Fire**: 아직 제출 완료 안 됨

---

## 4. 구현 검증 포인트

### 필수 확인 사항
1. **제출 성공 후 발생**
   - 버튼 클릭 시점이 아닌 API 성공 후
   - 제출 실패 시 미발생

2. **리뷰 정보 수집**
   - item_id: 리뷰 대상 상품
   - rating: 부여한 별점
   - review_type: 리뷰 유형 (텍스트/포토)

3. **모든 리뷰 유형 지원**
   - 일반 텍스트 리뷰
   - 포토 리뷰
   - 동영상 리뷰 (있는 경우)

### 흔한 구현 오류
| 문제 | 증상 | 해결 방법 |
|-----|------|----------|
| 클릭 시 발생 | 실패해도 이벤트 발생 | 성공 콜백에서 push |
| rating 누락 | 별점 정보 없음 | rating 파라미터 추가 |
| 포토 리뷰 누락 | 텍스트만 트래킹 | 모든 유형 적용 |

---

## 5. 수집 파라미터

> **중요**: 아래 파라미터는 대표 예시입니다.
> 실제 구현은 사이트별 GTM 설정에 따라 다르므로, **시나리오 설계 시 반드시 GTM 파싱을 통해 실제 파라미터를 확인**해야 합니다.
> GTM 파싱 방법: [docs/gtm-parsing-guide.md](../docs/gtm-parsing-guide.md) 참조

### 이벤트 레벨 파라미터

| 파라미터 | 설명 | 예시 | 필수 |
|---------|------|------|-----|
| item_id | 상품 ID | "SKU_12345" | O |
| item_name | 상품명 | "수분 크림" | O |
| rating | 별점 (1~5) | 5 | O |
| review_type | 리뷰 유형 | "text", "photo", "video" | △ |
| review_length | 리뷰 글자수 | 150 | △ |

### 사이트별 추가 파라미터 (Amoremall 기준)

| 파라미터 | 설명 | 예시 |
|---------|------|------|
| item_brand | 브랜드명 | "설화수" |
| item_category | 상품 카테고리 | "스킨케어" |
| has_image | 이미지 첨부 여부 | true, false |
| image_count | 첨부 이미지 수 | 3 |
| user_id | 작성자 ID | "user_12345" |
| order_id | 구매 주문번호 | "ORD_12345" |

---

## 6. 관련 이벤트

| 이벤트 | 발생 시점 | 구분 |
|-------|----------|------|
| `purchase` | 구매 완료 | 리뷰 작성 가능 조건 |
| `write_review` | 리뷰 작성 완료 | 리뷰 제출 성공 |

---

## 7. 시나리오 예시

### Should Fire (리뷰 제출 성공 시)
```
- 상품 상세 페이지에서 별점 + 텍스트 리뷰 작성 완료
- 마이페이지에서 구매 상품 리뷰 작성 완료
- 포토 리뷰 (이미지 첨부) 작성 완료
- 리뷰 작성 완료 후 "리뷰가 등록되었습니다" 메시지 표시
```

### Should NOT Fire
```
- 리뷰 작성 버튼 클릭 (작성 폼 열림)
- 리뷰 내용 입력 중 (아직 제출 전)
- 별점만 선택 (내용 없이)
- 리뷰 제출 실패 (에러 발생)
- Q&A 질문 작성 (리뷰 아님)
- 리뷰 목록 조회 (작성이 아님)
```

### 구현 필요 (Gap)
```
- 리뷰 제출해도 dataLayer push 없음
- 등록 버튼 클릭 시점에 발생 (성공 전)
- rating, item_id 등 필수 파라미터 누락
- 포토 리뷰만 트래킹되고 텍스트 리뷰 누락
```

### 상세 시나리오 매트릭스

| 시나리오 | 진행방법 | 발생해야 하는 상황 | 발생하면 안 되는 상황 | 주요 검수 포인트 |
|---------|---------|------------------|---------------------|----------------|
| **리뷰 등록 성공** | 리뷰 작성 | 서버에서 리뷰 등록 성공 응답을 받았을 때 | 리뷰 작성 양식을 여는 단계에서 발생 | 이벤트 발생 타이밍, 유효성 검사 통과 확인 |
| **리뷰 수정 성공** | 리뷰 수정 | - | 리뷰 수정해서 작성했을 경우 | 리뷰 수정 후 이벤트 발생 여부 확인 (신규 작성만 트래킹) |
| **리뷰 취소** | 취소 버튼 클릭 | - | 리뷰 작성 취소 시 발생 | 데이터 무결성 검증, 서버 응답 로깅 |

### 시나리오별 상세 검증 항목

#### 1) 리뷰 등록 성공
```
진행 방법:
1. 상품 상세 페이지 또는 마이페이지에서 리뷰 작성 폼 열기
2. 별점 선택 + 텍스트 입력 (+ 이미지 첨부)
3. 등록 버튼 클릭
4. 서버 응답 성공 확인

검증 항목:
□ 서버 성공 응답 후 write_review 이벤트 발생
□ 등록 버튼 클릭 시점이 아닌 성공 응답 후 발생
□ item_id가 리뷰 대상 상품과 일치
□ rating이 선택한 별점과 일치
□ review_type이 리뷰 유형(text/photo)과 일치
```

#### 2) 리뷰 수정 성공
```
진행 방법:
1. 기존 작성한 리뷰의 수정 버튼 클릭
2. 리뷰 내용/별점 수정
3. 수정 완료 버튼 클릭

검증 항목:
□ 리뷰 수정 시 write_review 이벤트 미발생
□ 수정은 신규 작성이 아니므로 트래킹 제외
□ (정책에 따라) 수정 전용 이벤트 발생 여부 확인
```

#### 3) 리뷰 취소
```
진행 방법:
1. 리뷰 작성 폼에서 내용 입력
2. 취소 버튼 클릭 또는 창 닫기
3. 작성 취소 확인

검증 항목:
□ 취소 시 write_review 이벤트 미발생
□ 입력 중이던 데이터가 dataLayer에 push되지 않음
□ 취소 후 다시 작성 시 정상 발생 확인
```

---

## 8. 시나리오 작성 지침

### 트리거 타입: CUSTOM_EVENT (dataLayer.push)

이 이벤트는 **dataLayer.push로 발생**합니다.
리뷰 제출 성공 시 프론트엔드에서 dataLayer.push를 호출하여 이벤트를 발생시킵니다.

### 시나리오에 포함할 내용
```
O 포함해야 함:
- 예상 dataLayer 구조 (dataLayer.push 코드)
- event 이름 (사이트별 site-config.json에서 확인)
- item_id, rating 등 파라미터

X 포함하지 않음:
- GTM LINK_CLICK 트리거 관련 내용
- DOM 속성에서 데이터 추출하는 방식
```

### 예상 dataLayer 구조 (시나리오에 포함)

**사이트별 event명 확인 필수**: `sites/{site}/site-config.json` → `eventMapping.write_review`

```javascript
// 예시: Amoremall (event: "review")
dataLayer.push({
  event: "review",  // site-config.json에서 확인
  item_id: "SKU_12345",
  item_name: "수분 크림",
  rating: 5,
  review_type: "photo" // 또는 "text"
});
```

### 검증 포인트
```
1. dataLayer 확인:
   - 개발자도구 Console에서 dataLayer 배열 확인
   - write_review 이벤트 객체가 push되는지 확인

2. 발생 시점 확인:
   - 리뷰 제출 버튼 클릭이 아닌 제출 성공 후 발생
   - 제출 실패 시 미발생
   - 모든 리뷰 유형(텍스트, 포토)에서 발생
```

---

## 9. 환경별 검증

> **공통 가이드 참조**: [docs/environment-validation-guide.md](../docs/environment-validation-guide.md)
>
> PC/Mobile, 로그인/비로그인 환경별 검증은 공통 가이드를 참조하세요.

### write_review 특화 환경 검증

| 환경 | 특이사항 |
|-----|---------|
| Mobile | 이미지 업로드 UI, 카메라 촬영 후 리뷰 등록 확인 |
| PC | 파일 드래그 앤 드롭으로 이미지 첨부 시 이벤트 발생 확인 |
| 로그인 필수 | 리뷰 작성은 로그인 필수이므로 user_id 포함 확인 |
