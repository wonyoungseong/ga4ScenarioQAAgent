# sign_up 이벤트 가이드

## 이벤트 정의
**사용자가 회원가입을 완료했을 때** 발생하는 이벤트입니다.
회원가입 폼 제출이 아닌, 가입 프로세스가 성공적으로 완료된 시점에 발생합니다.

## GTM 트리거 조건 (실제 구현)

### 트리거 타입
- **CUSTOM_EVENT** (dataLayer push)

### 트리거 설명
- 회원가입 성공 후 `dataLayer.push`로 이벤트 전송
- 프론트엔드에서 회원가입 API 응답 성공 시 발생
- **실제 event명은 사이트별로 상이** - `site-config.json` 참조

## 이벤트 발생 조건

### 발생 시점
1. 회원가입 폼 제출 후 가입 성공
2. 소셜 계정 연동 회원가입 완료
3. 본인인증 완료 후 가입 완료

### dataLayer 구조

**참고**: 실제 `event` 값은 사이트마다 다릅니다. `sites/{site}/site-config.json`의 `eventMapping.sign_up` 값을 확인하세요.

```javascript
// GA4 이벤트: sign_up
// dataLayer event명은 사이트별 설정 참조
dataLayer.push({
  event: "[eventMapping.sign_up]",  // 예: "sign_up_complete", "sign_up" 등
  method: "email" // 또는 "kakao", "naver" 등
});
```

### 사이트별 dataLayer event명 예시
| 사이트 | dataLayer event | 설정 파일 |
|-------|-----------------|----------|
| Amoremall | `sign_up_complete` | `sites/amoremall-kr/site-config.json` |
| Innisfree Shopify | `sign_up_complete` | `sites/innisfree-shopify/site-config.json` |

## 시각적 판단 기준

### 이벤트가 발생해야 하는 상황 (Should Fire)

1. **회원가입 완료 페이지**
   - "가입이 완료되었습니다" 메시지 표시
   - 환영 메시지 또는 웰컴 쿠폰 안내

2. **소셜 가입 완료**
   - 카카오/네이버 등으로 첫 로그인 시 가입 완료

3. **약관 동의 후 가입 완료**
   - 필수 정보 입력 및 약관 동의 후 가입 버튼 클릭 → 성공

### 이벤트가 발생하면 안 되는 상황 (Should NOT Fire)

1. **가입 진행 중**
   - 약관 동의 페이지
   - 정보 입력 페이지

2. **가입 실패**
   - 중복 이메일 등 오류 발생

3. **로그인**
   - 기존 회원 로그인 → `login` 이벤트

## 시각적 특징 (Visual Cues)

### 가입 전
- "회원가입" 버튼/링크
- 가입 폼 (이메일, 비밀번호, 이름 등)

### 가입 후 (이벤트 발생)
- 가입 완료 확인 메시지
- 환영 페이지 또는 메인 페이지로 이동
- 웰컴 쿠폰/혜택 안내

## 혼동하기 쉬운 이벤트

| 이벤트 | 발생 시점 | 차이점 |
|-------|----------|--------|
| `sign_up` | 회원가입 완료 시 | 신규 가입 시만 발생 |
| `login` | 로그인 성공 시 | 기존 회원 로그인 시 발생 |

## 수집 파라미터

> **중요**: 아래 파라미터는 대표 예시입니다.
> 실제 구현은 사이트별 GTM 설정에 따라 다르므로, **시나리오 설계 시 반드시 GTM 파싱을 통해 실제 파라미터를 확인**해야 합니다.
> GTM 파싱 방법: [docs/gtm-parsing-guide.md](../docs/gtm-parsing-guide.md) 참조

### 이벤트 레벨 파라미터

| 파라미터 | 설명 | 예시 |
|---------|------|------|
| event_category | 이벤트 카테고리 | "sign up" |
| event_action | 이벤트 액션 | "sign up complete" |
| event_label | 이벤트 라벨 | 가입 관련 라벨 |
| method | 가입 방식 | "email", "kakao", "naver", "google" |

## 주의사항

1. **신규 가입만**: 기존 회원 재로그인은 `login` 이벤트
2. **완료 시점**: 폼 제출이 아닌 가입 성공 확인 시 발생
3. **한 번만 발생**: 동일 사용자는 한 번만 발생 가능

### 흔한 구현 오류
| 문제 | 증상 | 해결 방법 |
|-----|------|----------|
| 클릭 시 발생 | 실패해도 이벤트 발생 | 성공 콜백에서 push |
| 소셜 가입 누락 | 카카오/네이버 가입 트래킹 없음 | OAuth 콜백에서 push |
| method 누락 | 가입 방식 구분 불가 | method 파라미터 추가 |
| **dataLayer 중복 push** | 동일 가입 sign_up 2회 발생 | dataLayer push 호출 지점 확인 |

---

## 7. 시나리오 예시

### 상세 시나리오 매트릭스

| 시나리오 | 진행방법 | 발생해야 하는 상황 | 발생하면 안 되는 상황 | 주요 검수 포인트 |
|---------|---------|------------------|---------------------|----------------|
| **회원가입 성공** | 회원가입 성공 | 서버에서 모든 유효성 검사를 통과하고 사용자 계정 생성이 완료된 후 응답을 받았을 때 | 유효성 검사 실패(예: 이메일 형식 불일치, 비밀번호 요구사항 미충족 등)로 인해 회원가입이 실패했을 때 | 사용자 계정 생성 확인, 서버 응답의 정확성 검증 |
| **회원가입 실패** | 회원가입 시도 | - | 사용자 계정 생성이 서버에서 거부되고 명확한 실패 메시지를 받았을 때 | 오류 메시지의 명확성, 실패 원인 로깅, 사용자 피드백 메시지의 적절성 확인 |
| **다중 단계 회원가입** | 회원 가입 진행 | 회원가입 절차가 여러 단계를 포함할 경우 각 단계를 성공적으로 완료했을 때 | 중간 단계에서 실패하거나 중단된 후에도 완료 이벤트가 발생하는 경우 | 각 단계별 완료 이벤트의 정확성, 중간 단계의 데이터 무결성 확인 |

### 시나리오별 상세 검증 항목

#### 1) 회원가입 성공
```
진행 방법:
1. 회원가입 페이지 접근
2. 이메일, 비밀번호, 필수 정보 입력
3. 약관 동의
4. 가입 버튼 클릭
5. 가입 성공 확인

검증 항목:
□ 서버에서 모든 유효성 검사를 통과했을 때 sign_up 이벤트 발생
□ 사용자 계정 생성이 완료된 후 응답을 받았을 때 발생
□ 유효성 검사 실패(이메일 형식 불일치, 비밀번호 요구사항 미충족 등) 시 미발생
□ 사용자 계정 생성 확인
□ 서버 응답의 정확성 검증
□ method 파라미터가 가입 방식과 일치 ("email", "kakao", "naver" 등)
```

#### 2) 회원가입 실패
```
진행 방법:
1. 회원가입 페이지 접근
2. 유효하지 않은 정보 입력 (중복 이메일, 잘못된 형식 등)
3. 가입 버튼 클릭
4. 실패 메시지 확인

검증 항목:
□ 사용자 계정 생성이 서버에서 거부되었을 때 sign_up 이벤트 미발생
□ 명확한 실패 메시지를 받았을 때 이벤트 미발생
□ 오류 메시지의 명확성 확인
□ 실패 원인이 적절히 로깅되는지 확인
□ 사용자 피드백 메시지의 적절성 확인
□ 여러 번 실패해도 sign_up 이벤트 미발생
```

#### 3) 다중 단계 회원가입
```
진행 방법:
1. 회원가입 1단계 진입 (기본 정보 입력)
2. 2단계 진행 (추가 정보 입력)
3. 3단계 진행 (본인 인증 등)
4. 최종 가입 완료

검증 항목:
□ 회원가입 절차가 여러 단계를 포함할 경우 모든 단계 완료 시 sign_up 발생
□ 중간 단계에서 실패하거나 중단된 경우 sign_up 미발생
□ 각 단계별 완료 이벤트의 정확성 확인 (단계별 별도 이벤트가 있는 경우)
□ 중간 단계의 데이터 무결성 확인
□ 최종 단계 완료 시에만 sign_up 이벤트 1회 발생
□ 중간 이탈 후 재진입 시 이벤트 중복 발생 방지
```

#### 4) dataLayer 중복 push로 인한 중복 발생 (주의 케이스)
```
발생 상황:
- 회원가입 완료 시 sign_up 이벤트가 2회 이상 발생
- 동일한 가입인데 이벤트가 중복으로 수집됨

원인 분석 방법:
1. 개발자 도구 Console에서 dataLayer 확인
2. dataLayer.filter(e => e.event === 'sign_up_complete') 실행 (사이트별 event명 확인)
3. sign_up 이벤트가 몇 번 push되었는지 확인

일반적인 중복 push 원인:
□ 프론트엔드 코드에서 dataLayer.push가 2회 호출됨
□ 가입 API 성공 콜백이 중복 실행됨
□ 소셜 가입 콜백과 완료 페이지에서 각각 push
□ GTM 태그 설정에서 중복 트리거 적용
□ 가입 완료 모달과 완료 페이지에서 각각 push

검증 항목:
□ dataLayer에서 sign_up 이벤트 push 횟수 확인 (1회만 되어야 함)
□ 중복 발생 시 두 이벤트의 데이터가 동일한지 비교
□ 발생 시점(timestamp) 확인하여 어느 지점에서 중복되는지 분석
□ 개발팀에 중복 push 지점 수정 요청

디버깅 코드 (Console에서 실행):
dataLayer.filter(e => e.event === 'sign_up_complete').forEach((e, i) => {
  console.log('sign_up push #' + (i+1), e);
});
```

---

## 8. 시나리오 작성 지침

### 트리거 타입: CUSTOM_EVENT (dataLayer.push)

이 이벤트는 **dataLayer.push로 발생**합니다.
회원가입 성공 시 프론트엔드에서 dataLayer.push를 호출하여 이벤트를 발생시킵니다.

### 시나리오에 포함할 내용
```
O 포함해야 함:
- 예상 dataLayer 구조 (dataLayer.push 코드)
- event 이름 (사이트별 site-config.json에서 확인)
- method 파라미터 (가입 방식)

X 포함하지 않음:
- GTM LINK_CLICK 트리거 관련 내용
- DOM 속성에서 데이터 추출하는 방식
```

### 예상 dataLayer 구조 (시나리오에 포함)

**사이트별 event명 확인 필수**: `sites/{site}/site-config.json` → `eventMapping.sign_up`

```javascript
// 예시: Amoremall (event: "sign_up_complete")
dataLayer.push({
  event: "sign_up_complete",  // site-config.json에서 확인
  method: "email" // 또는 "kakao", "naver" 등
});
```

### 검증 포인트
```
1. dataLayer 확인:
   - 개발자도구 Console에서 dataLayer 배열 확인
   - sign_up 이벤트 객체가 push되는지 확인

2. 발생 시점 확인:
   - 가입 버튼 클릭이 아닌 가입 성공 후 발생
   - 가입 실패/중복 시 미발생
   - 모든 가입 방식(일반, 소셜)에서 발생
```

---

## 9. 환경별 검증

> **공통 가이드 참조**: [docs/environment-validation-guide.md](../docs/environment-validation-guide.md)
>
> PC/Mobile, 로그인/비로그인 환경별 검증은 공통 가이드를 참조하세요.

### sign_up 특화 환경 검증

| 환경 | 특이사항 |
|-----|---------|
| Mobile | 소셜 가입 앱 호출 후 복귀 시 이벤트 발생 확인 |
| PC | 새 창/팝업 소셜 가입 완료 후 이벤트 발생 확인 |
| 이메일 인증 | 이메일 인증 완료 후 이벤트 발생 시점 확인 |
