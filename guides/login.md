# login 이벤트 가이드

## 이벤트 정의
**사용자가 로그인을 완료했을 때** 발생하는 이벤트입니다.
로그인 버튼 클릭이 아닌, 로그인 프로세스가 성공적으로 완료된 시점에 발생합니다.
**클릭이 아닌 인증 성공 시** 발생합니다.

---

## 1. 시각적 판단 기준 (Primary - 화면에서 찾기)

### 로그인 영역의 시각적 특징

#### 1) 로그인 폼
- **위치**: 로그인 페이지 중앙 또는 모달
- **구성 요소**:
  - 아이디/이메일 입력 필드
  - 비밀번호 입력 필드
  - "로그인" 버튼
  - "아이디/비밀번호 찾기" 링크
  - "회원가입" 링크

#### 2) 소셜 로그인 버튼
- **위치**: 로그인 폼 하단 또는 옆
- **형태**: 소셜 서비스 로고 + 버튼
- **예시**:
  - 카카오 로그인 (노란색)
  - 네이버 로그인 (초록색)
  - 구글 로그인
  - 애플 로그인

#### 3) 로그인 상태 표시
- **비로그인 시**: "로그인" 텍스트/버튼
- **로그인 후**:
  - 사용자 이름 표시
  - "마이페이지" 링크
  - 프로필 아이콘 변경

### 로그인 영역이 아닌 화면 (시각적 구분)

| 영역 | 특징 | 해당 이벤트 |
|-----|------|--------------|
| 회원가입 폼 | 추가 정보 입력 (이름, 연락처) | `sign_up` |
| 비밀번호 변경 | 현재/새 비밀번호 입력 | 없음 |
| 결제 페이지 | 주문서 양식 | `begin_checkout` |

---

## 2. GTM 트리거 조건 (검증용)

### 현재 구현된 조건
```
트리거 타입: CUSTOM_EVENT (dataLayer push)
Custom Event: [사이트별 상이 - site-config.json 참조]
발생 시점: 로그인 API 응답 성공 시
```

### 발생 조건
```
- 로그인 폼 제출 후 인증 성공
- 소셜 로그인 (카카오, 네이버 등) 완료
- 자동 로그인으로 세션 복원 (선택)
```

### dataLayer 구조

**참고**: 실제 `event` 값은 사이트마다 다릅니다. `sites/{site}/site-config.json`의 `eventMapping.login` 값을 확인하세요.

```javascript
// GA4 이벤트: login
// dataLayer event명은 사이트별 설정 참조
dataLayer.push({
  event: "[eventMapping.login]",  // 예: "login_complete", "login" 등
  method: "email" // 또는 "kakao", "naver", "google" 등
});
```

### 사이트별 dataLayer event명 예시
| 사이트 | dataLayer event | 설정 파일 |
|-------|-----------------|----------|
| Amoremall | `login_complete` | `sites/amoremall-kr/site-config.json` |
| Innisfree Shopify | `login_complete` | `sites/innisfree-shopify/site-config.json` |

---

## 3. 분석 판단 프로세스

### Step 1: 시각적으로 로그인 영역 식별
화면에서 다음 특징을 가진 요소를 찾습니다:
- 아이디/비밀번호 입력 필드
- "로그인" 버튼
- 소셜 로그인 버튼

### Step 2: 로그인 상태 확인
다음 기준으로 확인합니다:
- **로그인 전**: "로그인" 버튼 표시
- **로그인 후**: 사용자명 또는 마이페이지 링크 표시

### Step 3: 트래킹 확인
- 로그인 성공 시 dataLayer에 `login` 이벤트 push 여부
- method 파라미터 포함 여부

### Step 4: 결과 분류

#### Case A: 로그인 완료 + 트래킹 있음
→ **Should Fire**: 인증 성공 후 이벤트 발생

#### Case B: 로그인 완료 + 트래킹 없음
→ **구현 누락**: 로그인 성공 콜백에 dataLayer push 추가 필요

#### Case C: 로그인 버튼 클릭만 (인증 전)
→ **Should NOT Fire**: 아직 인증 완료 안 됨

---

## 4. 구현 검증 포인트

### 필수 확인 사항
1. **모든 로그인 방식에서 트래킹**
   - 일반 로그인 (이메일/아이디)
   - 소셜 로그인 (카카오, 네이버, 구글 등)
   - 자동 로그인 (선택)

2. **발생 시점**
   - 로그인 버튼 클릭이 아닌 인증 성공 후
   - 로그인 실패 시 미발생

3. **method 파라미터**
   - 로그인 방식 식별 가능해야 함

### 흔한 구현 오류
| 문제 | 증상 | 해결 방법 |
|-----|------|----------|
| 클릭 시 발생 | 실패해도 이벤트 발생 | 성공 콜백에서 push |
| 소셜 로그인 누락 | 카카오/네이버 트래킹 없음 | OAuth 콜백에서 push |
| method 누락 | 로그인 방식 구분 불가 | method 파라미터 추가 |
| **dataLayer 중복 push** | 동일 세션 login 2회 발생 | dataLayer push 호출 지점 확인 |

---

## 5. 수집 파라미터

> **중요**: 아래 파라미터는 **대표 예시**입니다.
> 실제 구현은 사이트별 GTM 설정에 따라 다르므로, **시나리오 설계 시 반드시 GTM 파싱을 통해 실제 파라미터를 확인**해야 합니다.
>
> ⚠️ **필수 확인 사항**: 없는 파라미터나 추가해야 하는 파라미터는 항상 **GTM parser를 통해 확인**이 필요합니다.
> GTM 파싱 방법: [docs/gtm-parsing-guide.md](../docs/gtm-parsing-guide.md) 참조

### GTM Variable 참조 (Amoremall 기준)

| 파라미터 | GTM Variable | 설명 |
|---------|--------------|------|
| event_category | (하드코딩) | "login" |
| event_action | (하드코딩) | "login complete" |
| event_label | `{{DL - Event Label with customEvent}}` | 로그인 관련 라벨 |
| event_time_kst | `{{JS - Event Time KST}}` | 이벤트 발생 시간 (KST) |

> 💡 **참고**: login 이벤트는 items 배열이 없으며, 주로 로그인 방식(method)과 시간 정보를 수집합니다.

### 이벤트 레벨 파라미터

| 파라미터 | 설명 | 예시 |
|---------|------|------|
| event_category | 이벤트 카테고리 | "login" |
| event_action | 이벤트 액션 | "login complete" |
| event_label | 이벤트 라벨 | 로그인 관련 라벨 |
| method | 로그인 방식 | "email", "kakao", "naver", "google" |

### 사이트별 추가 파라미터 (Amoremall 예시)

| 파라미터 | 설명 | GTM 변수 |
|---------|------|----------|
| event_time_kst | 이벤트 발생 시간 (KST) | {{JS - Event Time KST}} |

---

## 6. 관련 이벤트

| 이벤트 | 발생 시점 | 구분 |
|-------|----------|------|
| `login` | 로그인 성공 | 인증 완료 후 |
| `sign_up` | 회원가입 완료 | 신규 가입 시 |

---

## 7. 시나리오 예시

### Should Fire (인증 성공 후)
```
- 이메일/비밀번호 입력 후 로그인 성공
- 카카오 계정으로 로그인 완료
- 네이버 계정으로 로그인 완료
- 자동 로그인으로 세션 복원 (구현에 따라)
- 마이페이지로 리다이렉트되며 로그인 상태 확인
```

### Should NOT Fire
```
- 로그인 버튼 클릭 (인증 전)
- 로그인 폼이 화면에 표시
- 비밀번호 오류로 로그인 실패
- 회원가입 완료 → sign_up
- 이미 로그인 상태에서 페이지 새로고침 (선택)
```

### 구현 필요 (Gap)
```
- 로그인 성공해도 dataLayer push 없음
- 소셜 로그인 시 트래킹 누락
- 로그인 버튼 클릭 시점에 발생 (인증 전)
- method 파라미터 없이 이벤트만 발생
```

### 상세 시나리오 매트릭스

| 시나리오 | 진행방법 | 발생해야 하는 상황 | 발생하면 안 되는 상황 | 주요 검수 포인트 |
|---------|---------|------------------|---------------------|----------------|
| **로그인 성공** | 로그인 시도 | 서버로부터 사용자 인증 성공 메시지를 받고 사용자 세션 생성이 완료되었을 때 | 로그인 실패 응답(예: 비밀번호 오류, 사용자 존재하지 않음 등)을 받았을 때 | 사용자 세션 확인, 인증 과정의 데이터 무결성 검증 |
| **로그인 실패** | PASSWORD 잘못 입력 | - | 사용자 인증이 실패하고 시스템이 명확한 실패 메시지를 제공할 때 | 오류 메시지와 실패 원인 로깅, 사용자에게 명확한 피드백 제공 확인 |
| **세션 만료 후 재로그인** | 모든 쿠키, 캐시, 스토리지 삭제 후 재로그인 | 사용자 세션이 만료된 후 다시 로그인할 때 정상적으로 세션을 재생성할 때 | 세션 만료 후 로그인 재시도 시에 적절한 인증 없이 이전 세션 정보를 재사용하는 경우 | 세션 관리 검증, 세션 만료 및 재인증 절차의 적절성 확인 |

### 시나리오별 상세 검증 항목

#### 1) 로그인 성공
```
진행 방법:
1. 로그인 페이지 접근
2. 이메일/비밀번호 입력
3. 로그인 버튼 클릭
4. 인증 성공 확인

검증 항목:
□ 서버로부터 사용자 인증 성공 메시지를 받았을 때 login 이벤트 발생
□ 사용자 세션 생성이 완료되었을 때 발생
□ 로그인 실패 응답(비밀번호 오류, 사용자 존재하지 않음 등) 시 미발생
□ 사용자 세션 확인
□ 인증 과정의 데이터 무결성 검증
□ method 파라미터가 로그인 방식과 일치 ("email", "kakao", "naver" 등)
```

#### 2) 로그인 실패
```
진행 방법:
1. 로그인 페이지 접근
2. 잘못된 비밀번호 입력
3. 로그인 버튼 클릭
4. 실패 메시지 확인

검증 항목:
□ 사용자 인증이 실패했을 때 login 이벤트 미발생
□ 시스템이 명확한 실패 메시지를 제공하는지 확인
□ 오류 메시지와 실패 원인이 적절히 로깅되는지 확인
□ 사용자에게 명확한 피드백이 제공되는지 확인
□ 여러 번 실패해도 login 이벤트 미발생
```

#### 3) 세션 만료 후 재로그인
```
진행 방법:
1. 로그인 후 세션 생성 확인
2. 브라우저에서 모든 쿠키, 캐시, 스토리지 삭제
3. 페이지 새로고침하여 세션 만료 확인
4. 다시 로그인 시도

검증 항목:
□ 세션 만료 후 다시 로그인할 때 정상적으로 세션 재생성 시 login 이벤트 발생
□ 적절한 인증 없이 이전 세션 정보를 재사용하는 경우 미발생
□ 세션 관리가 적절히 이루어지는지 검증
□ 세션 만료 및 재인증 절차의 적절성 확인
□ 새 세션에서 login 이벤트가 정상적으로 1회 발생
```

#### 4) dataLayer 중복 push로 인한 중복 발생 (주의 케이스)
```
발생 상황:
- 로그인 성공 시 login 이벤트가 2회 이상 발생
- 동일한 로그인 세션인데 이벤트가 중복으로 수집됨

원인 분석 방법:
1. 개발자 도구 Console에서 dataLayer 확인
2. dataLayer.filter(e => e.event === 'login_complete') 실행 (사이트별 event명 확인)
3. login 이벤트가 몇 번 push되었는지 확인

일반적인 중복 push 원인:
□ 프론트엔드 코드에서 dataLayer.push가 2회 호출됨
□ 로그인 API 성공 콜백이 중복 실행됨
□ 소셜 로그인 콜백과 페이지 리다이렉트에서 각각 push
□ GTM 태그 설정에서 중복 트리거 적용
□ 로그인 모달과 로그인 페이지에서 각각 push

검증 항목:
□ dataLayer에서 login 이벤트 push 횟수 확인 (1회만 되어야 함)
□ 중복 발생 시 두 이벤트의 데이터가 동일한지 비교
□ 발생 시점(timestamp) 확인하여 어느 지점에서 중복되는지 분석
□ 개발팀에 중복 push 지점 수정 요청

디버깅 코드 (Console에서 실행):
dataLayer.filter(e => e.event === 'login_complete').forEach((e, i) => {
  console.log('login push #' + (i+1), e);
});
```

---

## 8. 시나리오 작성 지침

### 트리거 타입: CUSTOM_EVENT (dataLayer.push)

이 이벤트는 **dataLayer.push로 발생**합니다.
로그인 성공 시 프론트엔드에서 dataLayer.push를 호출하여 이벤트를 발생시킵니다.

### 시나리오에 포함할 내용
```
O 포함해야 함:
- 예상 dataLayer 구조 (dataLayer.push 코드)
- event 이름 (사이트별 site-config.json에서 확인)
- method 파라미터 (로그인 방식)

X 포함하지 않음:
- GTM LINK_CLICK 트리거 관련 내용
- DOM 속성에서 데이터 추출하는 방식
```

### 예상 dataLayer 구조 (시나리오에 포함)

**사이트별 event명 확인 필수**: `sites/{site}/site-config.json` → `eventMapping.login`

```javascript
// 예시: Amoremall (event: "login_complete")
dataLayer.push({
  event: "login_complete",  // site-config.json에서 확인
  method: "email" // 또는 "kakao", "naver", "google" 등
});
```

### 검증 포인트
```
1. dataLayer 확인:
   - 개발자도구 Console에서 dataLayer 배열 확인
   - login 이벤트 객체가 push되는지 확인

2. 발생 시점 확인:
   - 로그인 버튼 클릭이 아닌 인증 성공 후 발생
   - 로그인 실패 시 미발생
   - 모든 로그인 방식(일반, 소셜)에서 발생
```

---

## 9. 환경별 검증

> **공통 가이드 참조**: [docs/environment-validation-guide.md](../docs/environment-validation-guide.md)
>
> PC/Mobile, 로그인/비로그인 환경별 검증은 공통 가이드를 참조하세요.

### login 특화 환경 검증

| 환경 | 특이사항 |
|-----|---------|
| Mobile | 소셜 로그인 앱 호출 후 복귀 시 이벤트 발생 확인 |
| PC | 새 창/팝업 소셜 로그인 완료 후 이벤트 발생 확인 |
| 자동 로그인 | 세션 쿠키로 자동 로그인 시 이벤트 발생 여부 (정책에 따라) |
